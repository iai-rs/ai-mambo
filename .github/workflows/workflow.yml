name: Build docker container with ssh

on:
  push:
    branches:
      - development

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Executing remote ssh commands
        uses: appleboy/ssh-action@v1.0.3
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          AUTH_SECRET: ${{ secrets.AUTH_SECRET }}
          ORACLE_S3_KEY_FILE_ENCODED: ${{ secrets.ORACLE_S3_KEY_FILE_ENCODED }}
          ORACLE_S3_USER: ${{ secrets.ORACLE_S3_USER }}
          ORACLE_S3_TENANCY: ${{ secrets.ORACLE_S3_TENANCY }}
          ORACLE_S3_FINGERPRINT: ${{ secrets.ORACLE_S3_FINGERPRINT }}
          ORACLE_NAMESPACE_NAME: ${{ secrets.ORACLE_NAMESPACE_NAME }}
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT }}
          envs: DATABASE_URL,AUTH_SECRET,ORACLE_S3_KEY_FILE_ENCODED,ORACLE_S3_USER,ORACLE_S3_TENANCY,ORACLE_S3_FINGERPRINT,ORACLE_NAMESPACE_NAME
          script: |
            cd ai-mambo/
            git checkout development
            git pull
            docker build -t nextjs-app .
            # docker build -t nextjs-app \
            # --build-arg DATABASE_URL=${DATABASE_URL} \
            # --build-arg AUTH_SECRET=${AUTH_SECRET} \
            # --build-arg ORACLE_S3_KEY_FILE_ENCODED=${ORACLE_S3_KEY_FILE_ENCODED} \
            # --build-arg ORACLE_S3_USER=${ORACLE_S3_USER} \
            # --build-arg ORACLE_S3_TENANCY=${ORACLE_S3_TENANCY} \
            # --build-arg ORACLE_S3_FINGERPRINT=${ORACLE_S3_FINGERPRINT} \
            # --build-arg ORACLE_NAMESPACE_NAME=${ORACLE_NAMESPACE_NAME} \
            # --build-arg MINIO_SECRET_KEY="test" \
            # --build-arg MINIO_ACCESS_KEY="test" \
            # --build-arg MINIO_ENDPOINT="test" \
            # .
            docker stop nextjs-app
            docker rm nextjs-app
            docker run -d -p 55614:3000 \
              -e DATABASE_URL=${DATABASE_URL} \
              -e AUTH_SECRET=${AUTH_SECRET} \
              -e ORACLE_S3_KEY_FILE_ENCODED=${ORACLE_S3_KEY_FILE_ENCODED} \
              -e ORACLE_S3_USER=${ORACLE_S3_USER} \
              -e ORACLE_S3_TENANCY=${ORACLE_S3_TENANCY} \
              -e ORACLE_S3_FINGERPRINT=${ORACLE_S3_FINGERPRINT} \
              -e ORACLE_NAMESPACE_NAME=${ORACLE_NAMESPACE_NAME} \
              -e MINIO_SECRET_KEY="test" \
              -e MINIO_ACCESS_KEY="test" \
              -e MINIO_ENDPOINT="test" \
              -e NEXTAUTH_URL="http://localhost:3000" \
              -e AUTH_TRUST_HOST="http://localhost:3000" \
              --name nextjs-app nextjs-app
            docker network connect mamo_network nextjs-app
